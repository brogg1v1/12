-- 全局服务与玩家获取
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local NPCFolders = workspace:WaitForChild("NPCFolders")
local FriendlyFolder = NPCFolders:WaitForChild("FriendlyFolder")
local EnemyFolder = NPCFolders:WaitForChild("EnemyFolder")

-- 主界面 GUI
local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.Name = "NPCHealthUI"

-- 总威胁值显示条
local totalThreatLabel = Instance.new("TextLabel", ScreenGui)
totalThreatLabel.Size = UDim2.new(0.3, 0, 0, 30)
totalThreatLabel.Position = UDim2.new(0.35, 0, 0, 0)
totalThreatLabel.BackgroundTransparency = 0.4
totalThreatLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
totalThreatLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
totalThreatLabel.Font = Enum.Font.SourceSansBold
totalThreatLabel.TextSize = 18
totalThreatLabel.Text = ""

-- 面板头部
local header = Instance.new("Frame", ScreenGui)
header.Size = UDim2.new(0.2, 0, 0, 30)
header.Position = UDim2.new(0.01, 0, 0.05, 0)
header.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
header.BackgroundTransparency = 0.3
header.BorderSizePixel = 0
header.Draggable = true
header.Active = true

local headerText = Instance.new("TextLabel", header)
headerText.Size = UDim2.new(1, -30, 1, 0)
headerText.Text = "NPC Health Display"
headerText.TextColor3 = Color3.fromRGB(255, 255, 255)
headerText.Font = Enum.Font.SourceSansBold
headerText.TextSize = 14
headerText.BackgroundTransparency = 1
headerText.TextXAlignment = Enum.TextXAlignment.Left

local closeButton = Instance.new("TextButton", header)
closeButton.Size = UDim2.new(0, 30, 1, 0)
closeButton.Position = UDim2.new(1, -30, 0, 0)
closeButton.Text = "X"
closeButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.Font = Enum.Font.SourceSansBold
closeButton.BorderSizePixel = 0

closeButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- 创建血条 BillboardGui
local function createBillboard(npc, isFriendly)
    if npc:FindFirstChild("BillboardGui") then return end

    local gui = Instance.new("BillboardGui")
    gui.Name = "BillboardGui"
    gui.Adornee = npc:FindFirstChild("Head")
    gui.Size = UDim2.new(0, 200, 0, 180)
    gui.StudsOffset = Vector3.new(0, 3, 0)
    gui.AlwaysOnTop = true
    gui.Parent = npc

    -- 显示 NPC 名称
    local nameLabel = Instance.new("TextLabel", gui)
    nameLabel.Size = UDim2.new(1, 0, 0.1, 0)
    nameLabel.Position = UDim2.new(0, 0, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.TextScaled = true
    nameLabel.Text = npc.Name

    -- 显示生命、攻击范围、伤害、移动速度等信息
    local labels = {
        { name = "healthLabel", label = "Health", color = Color3.fromRGB(255, 255, 255), posY = 0.1 },
        { name = "attackRangeLabel", label = "Attack Range", color = Color3.fromRGB(255, 165, 0), posY = 0.2 },
        { name = "damageLabel", label = "Damage", color = Color3.fromRGB(255, 0, 0), posY = 0.3 },
        { name = "walkSpeedLabel", label = "Walk Speed", color = Color3.fromRGB(0, 255, 255), posY = 0.4 },
        { name = "waitTimeLabel", label = "Wait Time", color = Color3.fromRGB(0, 255, 0), posY = 0.5 }
    }

    for _, labelData in ipairs(labels) do
        local label = Instance.new("TextLabel", gui)
        label.Size = UDim2.new(1, 0, 0.1, 0)
        label.Position = UDim2.new(0, 0, labelData.posY, 0)
        label.BackgroundTransparency = 1
        label.TextColor3 = labelData.color
        label.Font = Enum.Font.SourceSansBold
        label.TextScaled = true
        label.Name = labelData.name
    end

    -- 动态更新显示的血量、攻击范围、伤害、移动速度、等待时间等
    RunService.RenderStepped:Connect(function()
        local humanoid = npc:FindFirstChild("Humanoid")
        if humanoid then
            local healthLabel = gui:FindFirstChild("healthLabel")
            local attackRangeLabel = gui:FindFirstChild("attackRangeLabel")
            local damageLabel = gui:FindFirstChild("damageLabel")
            local walkSpeedLabel = gui:FindFirstChild("walkSpeedLabel")
            local waitTimeLabel = gui:FindFirstChild("waitTimeLabel")

            -- 假设伤害和攻击范围是由 NPC 的属性来决定的
            local attackRange = npc:FindFirstChild("AttackRange") and npc.AttackRange.Value or 10
            local damage = npc:FindFirstChild("Damage") and npc.Damage.Value or 5
            local waitTime = npc:FindFirstChild("WaitTime") and npc.WaitTime.Value or 2

            healthLabel.Text = "Health: " .. math.floor(humanoid.Health) .. " / " .. math.floor(humanoid.MaxHealth)
            attackRangeLabel.Text = "Attack Range: " .. attackRange
            damageLabel.Text = "Damage: " .. damage
            walkSpeedLabel.Text = "Walk Speed: " .. math.floor(humanoid.WalkSpeed)
            waitTimeLabel.Text = "Wait Time: " .. waitTime
        end
    end)
end

-- 创建敌我 NPC 并附加血条
for _, npc in ipairs(FriendlyFolder:GetChildren()) do
    createBillboard(npc, true)
end

for _, npc in ipairs(EnemyFolder:GetChildren()) do
    createBillboard(npc, false)
end

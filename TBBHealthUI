local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local NPCFolders = workspace:WaitForChild("NPCFolders")
local FriendlyFolder = NPCFolders:WaitForChild("FriendlyFolder")
local EnemyFolder = NPCFolders:WaitForChild("EnemyFolder")

local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.Name = "NPCHealthUI"

local header = Instance.new("Frame", ScreenGui)
header.Size = UDim2.new(0.18, 0, 0, 30)
header.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
header.BackgroundTransparency = 0.3
header.BorderSizePixel = 0
header.Draggable = true
header.Active = true

local headerText = Instance.new("TextLabel", header)
headerText.Size = UDim2.new(1, -60, 1, 0)
headerText.Text = "NPC Health Display"
headerText.TextColor3 = Color3.fromRGB(255, 255, 255)
headerText.Font = Enum.Font.SourceSansBold
headerText.TextSize = 14
headerText.BackgroundTransparency = 1
headerText.TextXAlignment = Enum.TextXAlignment.Left

local closeButton = Instance.new("TextButton", header)
closeButton.Size = UDim2.new(0, 30, 1, 0)
closeButton.Position = UDim2.new(1, -30, 0, 0)
closeButton.Text = "X"
closeButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.Font = Enum.Font.SourceSansBold
closeButton.BorderSizePixel = 0

local mainFrame = Instance.new("ScrollingFrame", header)
mainFrame.Size = UDim2.new(0, 200, 0, 300)
mainFrame.Position = UDim2.new(0, 10, 0, 30)
mainFrame.BackgroundTransparency = 0.2
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.Active = true
mainFrame.ScrollBarThickness = 6

local UIListLayout = Instance.new("UIListLayout", mainFrame)
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 5)

UIListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    mainFrame.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y)
end)

local function createBillboard(npc, isFriendly)
    if npc:FindFirstChild("BillboardGui") then return end

    local gui = Instance.new("BillboardGui")
    gui.Name = "BillboardGui"
    gui.Adornee = npc:FindFirstChild("Head")
    gui.Size = UDim2.new(0, 200, 0, 120) -- 调整大小以容纳更多信息
    gui.StudsOffset = Vector3.new(0, 3, 0)
    gui.AlwaysOnTop = true
    gui.Parent = npc

    local healthLabel = Instance.new("TextLabel", gui)
    healthLabel.Size = UDim2.new(1, 0, 0.2, 0)
    healthLabel.Position = UDim2.new(0, 0, 0, 0)
    healthLabel.BackgroundTransparency = 1
    healthLabel.TextColor3 = isFriendly and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
    healthLabel.Font = Enum.Font.SourceSansBold
    healthLabel.TextScaled = true

    local waitLabel = Instance.new("TextLabel", gui)
    waitLabel.Size = UDim2.new(1, 0, 0.2, 0)
    waitLabel.Position = UDim2.new(0, 0, 0.2, 0)
    waitLabel.BackgroundTransparency = 1
    waitLabel.TextColor3 = Color3.fromRGB(0, 170, 255)
    waitLabel.Font = Enum.Font.SourceSansBold
    waitLabel.TextScaled = true

    local rangeLabel = Instance.new("TextLabel", gui)
    rangeLabel.Size = UDim2.new(1, 0, 0.2, 0)
    rangeLabel.Position = UDim2.new(0, 0, 0.4, 0)
    rangeLabel.BackgroundTransparency = 1
    rangeLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    rangeLabel.Font = Enum.Font.SourceSansBold
    rangeLabel.TextScaled = true

    local damageLabel = Instance.new("TextLabel", gui)
    damageLabel.Size = UDim2.new(1, 0, 0.2, 0)
    damageLabel.Position = UDim2.new(0, 0, 0.6, 0)
    damageLabel.BackgroundTransparency = 1
    damageLabel.TextColor3 = Color3.fromRGB(255, 165, 0)
    damageLabel.Font = Enum.Font.SourceSansBold
    damageLabel.TextScaled = true

    local walkSpeedLabel = Instance.new("TextLabel", gui)
    walkSpeedLabel.Size = UDim2.new(1, 0, 0.2, 0)
    walkSpeedLabel.Position = UDim2.new(0, 0, 0.8, 0)
    walkSpeedLabel.BackgroundTransparency = 1
    walkSpeedLabel.TextColor3 = Color3.fromRGB(0, 255, 255)
    walkSpeedLabel.Font = Enum.Font.SourceSansBold
    walkSpeedLabel.TextScaled = true

    RunService.RenderStepped:Connect(function()
        if npc:FindFirstChild("Humanoid") then
            local humanoid = npc.Humanoid
            local health = math.floor(humanoid.Health)
            healthLabel.Text = npc.Name .. " HP: " .. health

            local waitToMove = npc:GetAttribute("WaitToMove")
            if waitToMove then
                waitLabel.Text = "Wait: " .. math.floor(waitToMove + 0.5)
            else
                waitLabel.Text = "Wait: N/A"
            end

            local range = npc:GetAttribute("Range")
            if range then
                rangeLabel.Text = "Range: " .. math.floor(range)
            else
                rangeLabel.Text = "Range: N/A"
            end

            local damage = npc:GetAttribute("Damage")
            if damage then
                damageLabel.Text = "Damage: " .. math.floor(damage)
            else
                damageLabel.Text = "Damage: N/A"
            end

            walkSpeedLabel.Text = "WalkSpeed: " .. math.floor(humanoid.WalkSpeed)
        end
    end)
end

task.spawn(function()
    while true do
        for _, folder in ipairs({FriendlyFolder, EnemyFolder}) do
            local isFriendly = folder == FriendlyFolder
            for _, npc in ipairs(folder:GetChildren()) do
                if npc:FindFirstChild("Humanoid") then
                    createBillboard(npc, isFriendly)
                end
            end
        end
        task.wait(1)
    end
end)

closeButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- 全局服务与玩家获取
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local NPCFolders = workspace:WaitForChild("NPCFolders")
local FriendlyFolder = NPCFolders:WaitForChild("FriendlyFolder")
local EnemyFolder = NPCFolders:WaitForChild("EnemyFolder")

-- 主界面 GUI
local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.Name = "NPCHealthUI"

-- 总威胁值显示条
local totalThreatLabel = Instance.new("TextLabel", ScreenGui)
totalThreatLabel.Size = UDim2.new(0.3, 0, 0, 30)
totalThreatLabel.Position = UDim2.new(0.35, 0, 0, 0)
totalThreatLabel.BackgroundTransparency = 0.4
totalThreatLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
totalThreatLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
totalThreatLabel.Font = Enum.Font.SourceSansBold
totalThreatLabel.TextSize = 18
totalThreatLabel.Text = ""

-- 面板头部
local header = Instance.new("Frame", ScreenGui)
header.Size = UDim2.new(0.2, 0, 0, 30)
header.Position = UDim2.new(0.01, 0, 0.05, 0)
header.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
header.BackgroundTransparency = 0.3
header.BorderSizePixel = 0
header.Draggable = true
header.Active = true

local headerText = Instance.new("TextLabel", header)
headerText.Size = UDim2.new(1, -30, 1, 0)
headerText.Text = "NPC Health Display"
headerText.TextColor3 = Color3.fromRGB(255, 255, 255)
headerText.Font = Enum.Font.SourceSansBold
headerText.TextSize = 14
headerText.BackgroundTransparency = 1
headerText.TextXAlignment = Enum.TextXAlignment.Left

local closeButton = Instance.new("TextButton", header)
closeButton.Size = UDim2.new(0, 30, 1, 0)
closeButton.Position = UDim2.new(1, -30, 0, 0)
closeButton.Text = "X"
closeButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.Font = Enum.Font.SourceSansBold
closeButton.BorderSizePixel = 0

closeButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- 控制面板
local controlToggle = Instance.new("TextButton", ScreenGui)
controlToggle.Size = UDim2.new(0, 120, 0, 25)
controlToggle.Position = UDim2.new(0.01, 0, 0.12, 0)
controlToggle.Text = "颜色+显示控制面板"
controlToggle.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
controlToggle.TextColor3 = Color3.new(1, 1, 1)

local colorPanel = Instance.new("Frame", ScreenGui)
colorPanel.Size = UDim2.new(0, 300, 0, 400)
colorPanel.Position = UDim2.new(0.01, 0, 0.18, 0)
colorPanel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
colorPanel.Visible = false
colorPanel.Active = true
colorPanel.Draggable = true

controlToggle.MouseButton1Click:Connect(function()
    colorPanel.Visible = not colorPanel.Visible
end)

-- 精度模式
local precisionMode = 0 -- 0整数, 1一位小数, 2两位小数

local function formatNumber(num)
    if precisionMode == 0 then
        return tostring(math.floor(num))
    elseif precisionMode == 1 then
        return string.format("%.1f", num)
    else
        return string.format("%.2f", num)
    end
end

-- 精度切换按钮
local integerBtn = Instance.new("TextButton", colorPanel)
integerBtn.Position = UDim2.new(0, 10, 0, 10)
integerBtn.Size = UDim2.new(0, 80, 0, 20)
integerBtn.Text = "整数显示"

local oneDecimalBtn = Instance.new("TextButton", colorPanel)
oneDecimalBtn.Position = UDim2.new(0, 100, 0, 10)
oneDecimalBtn.Size = UDim2.new(0, 80, 0, 20)
oneDecimalBtn.Text = "1位小数"

local twoDecimalBtn = Instance.new("TextButton", colorPanel)
twoDecimalBtn.Position = UDim2.new(0, 190, 0, 10)
twoDecimalBtn.Size = UDim2.new(0, 80, 0, 20)
twoDecimalBtn.Text = "2位小数"

integerBtn.MouseButton1Click:Connect(function()
    precisionMode = 0
end)
oneDecimalBtn.MouseButton1Click:Connect(function()
    precisionMode = 1
end)
twoDecimalBtn.MouseButton1Click:Connect(function()
    precisionMode = 2
end)

-- 勾选哪些信息
local showFields = {
    WaitToMove = true,
    Range = true,
    Damage = true,
    WalkSpeed = true,
    Resistance = true,
    Armor = true,
    AttackRate = true,
    AreaAttack = true,
    AntiTrait = true,
    DPS = true,
}

local function createCheckbox(fieldName, posY)
    local checkbox = Instance.new("TextButton", colorPanel)
    checkbox.Position = UDim2.new(0, 10, 0, posY)
    checkbox.Size = UDim2.new(0, 200, 0, 20)
    checkbox.Text = fieldName .. ": 开"
    checkbox.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    checkbox.TextColor3 = Color3.new(1,1,1)

    checkbox.MouseButton1Click:Connect(function()
        showFields[fieldName] = not showFields[fieldName]
        checkbox.Text = fieldName .. ": " .. (showFields[fieldName] and "开" or "关")
    end)
end

local y = 40
for fieldName, _ in pairs(showFields) do
    createCheckbox(fieldName, y)
    y += 25
end

-- 创建血条 BillboardGui
local function createBillboard(npc, isFriendly)
    if npc:FindFirstChild("BillboardGui") then return end

    local gui = Instance.new("BillboardGui")
    gui.Name = "BillboardGui"
    gui.Adornee = npc:FindFirstChild("Head")
    gui.Size = UDim2.new(0, 200, 0, 250)
    gui.StudsOffset = Vector3.new(0, 3, 0)
    gui.AlwaysOnTop = true
    gui.Parent = npc

    local fields = {"healthLabel", "waitLabel", "rangeLabel", "damageLabel", "walkSpeedLabel", "resistanceLabel", "armorLabel", "attackRateLabel", "areaAttackLabel", "antiTraitLabel", "dpsLabel", "threatLevelLabel"}

    for i, name in ipairs(fields) do
        local label = Instance.new("TextLabel", gui)
        label.Size = UDim2.new(1, 0, 0.08, 0)
        label.Position = UDim2.new(0, 0, (i-1)*0.08, 0)
        label.BackgroundTransparency = 1
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.Font = Enum.Font.SourceSansBold
        label.TextScaled = true
        label.Name = name
    end

    RunService.RenderStepped:Connect(function()
        local humanoid = npc:FindFirstChild("Humanoid")
        if humanoid then
            local function getAttr(name)
                return npc:GetAttribute(name)
            end

            local health = humanoid.Health
            local waitToMove = getAttr("WaitToMove") or 0
            local range = getAttr("Range")
            local damage = getAttr("Damage")
            local walkSpeed = humanoid.WalkSpeed
            local resistance = getAttr("Resistance")
            local armor = getAttr("Armor")
            local attackRate = getAttr("AttackRate") or 1
            local areaAttack = getAttr("AreaAttack")
            local antiTrait = getAttr("AntiTrait")
            local dps = (damage or 0) * attackRate

            local function setField(name, text)
                local label = gui:FindFirstChild(name)
                if label and showFields[name:gsub("Label", "")] then
                    label.Text = text
                    label.Visible = true
                elseif label then
                    label.Visible = false
                end
            end

            setField("healthLabel", npc.Name .. " HP: " .. formatNumber(health))
            setField("waitLabel", "Wait: " .. formatNumber(waitToMove))
            setField("rangeLabel", "Range: " .. (range and formatNumber(range) or "N/A"))
            setField("damageLabel", "Damage: " .. (damage and formatNumber(damage) or "N/A"))
            setField("walkSpeedLabel", "WalkSpeed: " .. formatNumber(walkSpeed))
            setField("resistanceLabel", "Resistance: " .. (resistance and formatNumber(resistance) or "N/A"))
            setField("armorLabel", "Armor: " .. (armor and formatNumber(armor) or "N/A"))
            setField("attackRateLabel", "AttackRate: " .. formatNumber(attackRate))
            if areaAttack then
                setField("areaAttackLabel", "AOE")
            else
                setField("areaAttackLabel", "")
            end
            setField("antiTraitLabel", "AntiTrait: " .. (antiTrait or "None"))
            setField("dpsLabel", "DPS: " .. formatNumber(dps))

            -- 威胁值
            local threat = 0
            if health ~= math.huge then threat += health * 0.3 end
            if range and range ~= math.huge then threat += range * 0.2 end
            if damage and damage ~= math.huge then threat += damage * 0.3 end
            if walkSpeed ~= math.huge then threat += walkSpeed * 0.2 end

            local threatLabel = gui:FindFirstChild("threatLevelLabel")
            if threatLabel then
                threatLabel.Text = "Threat: " .. formatNumber(threat)
            end
        end
    end)
end

-- 总威胁值刷新
local function updateTotalThreat()
    local sum = 0
    for _, npc in ipairs(EnemyFolder:GetChildren()) do
        local humanoid = npc:FindFirstChild("Humanoid")
        if humanoid then
            local health = humanoid.Health
            local range = npc:GetAttribute("Range")
            local damage = npc:GetAttribute("Damage")
            local walkSpeed = humanoid.WalkSpeed

            local threat = 0
            if health ~= math.huge then threat += health * 0.3 end
            if range and range ~= math.huge then threat += range * 0.2 end
            if damage and damage ~= math.huge then threat += damage * 0.3 end
            if walkSpeed ~= math.huge then threat += walkSpeed * 0.2 end

            sum += threat * 0.7
        end
    end

    totalThreatLabel.Text = "关卡总威胁值: " .. math.floor(sum)
    if sum > 6000 then
        totalThreatLabel.TextColor3 = Color3.fromRGB(180, 30, 30)
    elseif sum > 4000 then
        totalThreatLabel.TextColor3 = Color3.fromRGB(220, 60, 60)
    elseif sum > 2500 then
        totalThreatLabel.TextColor3 = Color3.fromRGB(255, 120, 120)
    else
        totalThreatLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    end
end

-- 初始化
RunService.RenderStepped:Connect(updateTotalThreat)

task.spawn(function()
    while true do
        for _, folder in ipairs({FriendlyFolder, EnemyFolder}) do
            local isFriendly = folder == FriendlyFolder
            for _, npc in ipairs(folder:GetChildren()) do
                if npc:FindFirstChild("Humanoid") then
                    createBillboard(npc, isFriendly)
                end
            end
        end
        task.wait(1)
    end
end)

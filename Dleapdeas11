-- 全局服务与玩家获取
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local NPCFolders = workspace:WaitForChild("NPCFolders")
local FriendlyFolder = NPCFolders:WaitForChild("FriendlyFolder")
local EnemyFolder = NPCFolders:WaitForChild("EnemyFolder")

-- 主界面 GUI
local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.Name = "NPCHealthUI"

-- 总威胁值显示条
local totalThreatLabel = Instance.new("TextLabel", ScreenGui)
totalThreatLabel.Size = UDim2.new(0.3, 0, 0, 30)
totalThreatLabel.Position = UDim2.new(0.35, 0, 0, 0)
totalThreatLabel.BackgroundTransparency = 0.4
totalThreatLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
totalThreatLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
totalThreatLabel.Font = Enum.Font.SourceSansBold
totalThreatLabel.TextSize = 18
totalThreatLabel.Text = ""

-- 面板头部
local header = Instance.new("Frame", ScreenGui)
header.Size = UDim2.new(0.2, 0, 0, 30)
header.Position = UDim2.new(0.01, 0, 0.05, 0)
header.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
header.BackgroundTransparency = 0.3
header.BorderSizePixel = 0
header.Draggable = true
header.Active = true

local headerText = Instance.new("TextLabel", header)
headerText.Size = UDim2.new(1, -30, 1, 0)
headerText.Text = "NPC Health Display"
headerText.TextColor3 = Color3.fromRGB(255, 255, 255)
headerText.Font = Enum.Font.SourceSansBold
headerText.TextSize = 14
headerText.BackgroundTransparency = 1
headerText.TextXAlignment = Enum.TextXAlignment.Left

local closeButton = Instance.new("TextButton", header)
closeButton.Size = UDim2.new(0, 30, 1, 0)
closeButton.Position = UDim2.new(1, -30, 0, 0)
closeButton.Text = "X"
closeButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.Font = Enum.Font.SourceSansBold
closeButton.BorderSizePixel = 0

closeButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- 控制面板
local controlToggle = Instance.new("TextButton", ScreenGui)
controlToggle.Size = UDim2.new(0, 100, 0, 25)
controlToggle.Position = UDim2.new(0.01, 0, 0.12, 0)
controlToggle.Text = "颜色控制面板"
controlToggle.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
controlToggle.TextColor3 = Color3.new(1, 1, 1)

local colorPanel = Instance.new("Frame", ScreenGui)
colorPanel.Size = UDim2.new(0, 250, 0, 250)
colorPanel.Position = UDim2.new(0.01, 0, 0.18, 0)
colorPanel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
colorPanel.Visible = false

controlToggle.MouseButton1Click:Connect(function()
    colorPanel.Visible = not colorPanel.Visible
end)

-- 模式切换按钮与颜色输入框生成函数
local function createColorControl(name, yPosition)
    local modeLabel = Instance.new("TextLabel", colorPanel)
    modeLabel.Text = name .. " 模式:"
    modeLabel.Position = UDim2.new(0, 10, 0, yPosition)
    modeLabel.Size = UDim2.new(0, 100, 0, 20)
    modeLabel.BackgroundTransparency = 1
    modeLabel.TextColor3 = Color3.new(1, 1, 1)
    modeLabel.TextXAlignment = Enum.TextXAlignment.Left

    local dropdown = Instance.new("TextButton", colorPanel)
    dropdown.Position = UDim2.new(0, 110, 0, yPosition)
    dropdown.Size = UDim2.new(0, 60, 0, 20)
    dropdown.Text = "自动"
    dropdown.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    dropdown.TextColor3 = Color3.new(1, 1, 1)

    local rBox = Instance.new("TextBox", colorPanel)
    rBox.PlaceholderText = "R"
    rBox.Position = UDim2.new(0, 10, 0, yPosition + 25)
    rBox.Size = UDim2.new(0, 60, 0, 20)
    local gBox = Instance.new("TextBox", colorPanel)
    gBox.PlaceholderText = "G"
    gBox.Position = UDim2.new(0, 80, 0, yPosition + 25)
    gBox.Size = UDim2.new(0, 60, 0, 20)
    local bBox = Instance.new("TextBox", colorPanel)
    bBox.PlaceholderText = "B"
    bBox.Position = UDim2.new(0, 150, 0, yPosition + 25)
    bBox.Size = UDim2.new(0, 60, 0, 20)

    return dropdown, rBox, gBox, bBox
end

local enemyModeBtn, enemyR, enemyG, enemyB = createColorControl("敌方", 10)
local friendlyModeBtn, friendlyR, friendlyG, friendlyB = createColorControl("友方", 70)

enemyModeBtn.MouseButton1Click:Connect(function()
    enemyModeBtn.Text = (enemyModeBtn.Text == "自动") and "手动" or "自动"
end)

friendlyModeBtn.MouseButton1Click:Connect(function()
    friendlyModeBtn.Text = (friendlyModeBtn.Text == "自动") and "手动" or "自动"
end)

-- 创建血条 BillboardGui
local function createBillboard(npc, isFriendly)
    if npc:FindFirstChild("BillboardGui") then return end

    local gui = Instance.new("BillboardGui")
    gui.Name = "BillboardGui"
    gui.Adornee = npc:FindFirstChild("Head")
    gui.Size = UDim2.new(0, 200, 0, 140)
    gui.StudsOffset = Vector3.new(0, 3, 0)
    gui.AlwaysOnTop = true
    gui.Parent = npc

    local labels = {
        { name = "healthLabel", color = Color3.fromRGB(255, 255, 255), posY = 0 },
        { name = "waitLabel", color = Color3.fromRGB(0, 170, 255), posY = 0.2 },
        { name = "rangeLabel", color = Color3.fromRGB(255, 255, 0), posY = 0.4 },
        { name = "damageLabel", color = Color3.fromRGB(255, 165, 0), posY = 0.6 },
        { name = "walkSpeedLabel", color = Color3.fromRGB(0, 255, 255), posY = 0.8 },
        { name = "threatLevelLabel", color = Color3.fromRGB(255, 0, 0), posY = 1.0 }
    }

    for _, labelData in ipairs(labels) do
        local label = Instance.new("TextLabel", gui)
        label.Size = UDim2.new(1, 0, 0.2, 0)
        label.Position = UDim2.new(0, 0, labelData.posY, 0)
        label.BackgroundTransparency = 1
        label.TextColor3 = labelData.color
        label.Font = Enum.Font.SourceSansBold
        label.TextScaled = true
        label.Name = labelData.name
    end

    RunService.RenderStepped:Connect(function()
        local humanoid = npc:FindFirstChild("Humanoid")
        if humanoid then
            local healthLabel = gui:FindFirstChild("healthLabel")
            local waitLabel = gui:FindFirstChild("waitLabel")
            local rangeLabel = gui:FindFirstChild("rangeLabel")
            local damageLabel = gui:FindFirstChild("damageLabel")
            local walkSpeedLabel = gui:FindFirstChild("walkSpeedLabel")
            local threatLevelLabel = gui:FindFirstChild("threatLevelLabel")

            local health = math.floor(humanoid.Health)
            local waitToMove = math.floor(npc:GetAttribute("WaitToMove") or 0.5)
            local range = npc:GetAttribute("Range")
            local damage = npc:GetAttribute("Damage")
            local walkSpeedRaw = humanoid.WalkSpeed
            local walkSpeed = walkSpeedRaw >= 1 and math.floor(walkSpeedRaw + 0.5) or math.floor(walkSpeedRaw * 10 + 0.5) / 10

            local healthW, rangeW, damageW, speedW = 0.3, 0.2, 0.3, 0.2
            local threatLevel = 0
            if health ~= math.huge then threatLevel += health * healthW end
            if range and range ~= math.huge then threatLevel += range * rangeW end
            if damage and damage ~= math.huge then threatLevel += damage * damageW end
            if walkSpeedRaw ~= math.huge then threatLevel += walkSpeedRaw * speedW end

            healthLabel.Text = npc.Name .. " HP: " .. health
            waitLabel.Text = "Wait: " .. waitToMove
            rangeLabel.Text = "Range: " .. (range and math.floor(range) or "N/A")
            damageLabel.Text = "Damage: " .. (damage and math.floor(damage) or "N/A")
            walkSpeedLabel.Text = "WalkSpeed: " .. walkSpeed
            threatLevelLabel.Text = "Threat Level: " .. string.format("%.2f", threatLevel)

            local mode = isFriendly and friendlyModeBtn.Text or enemyModeBtn.Text
            if mode == "自动" then
                healthLabel.TextColor3 = isFriendly and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 255, 255)
            else
                local r = tonumber((isFriendly and friendlyR.Text or enemyR.Text)) or 255
                local g = tonumber((isFriendly and friendlyG.Text or enemyG.Text)) or 255
                local b = tonumber((isFriendly and friendlyB.Text or enemyB.Text)) or 255
                healthLabel.TextColor3 = Color3.fromRGB(r, g, b)
            end
        end
    end)
end

-- 总威胁值刷新
local function updateTotalThreat()
    local sum = 0
    for _, npc in ipairs(EnemyFolder:GetChildren()) do
        local humanoid = npc:FindFirstChild("Humanoid")
        if humanoid then
            local health = math.floor(humanoid.Health)
            local range = npc:GetAttribute("Range")
            local damage = npc:GetAttribute("Damage")
            local walkSpeed = humanoid.WalkSpeed

            local healthW, rangeW, damageW, speedW = 0.3, 0.2, 0.3, 0.2
            local threat = 0
            if health ~= math.huge then threat += health * healthW end
            if range and range ~= math.huge then threat += range * rangeW end
            if damage and damage ~= math.huge then threat += damage * damageW end
            if walkSpeed ~= math.huge then threat += walkSpeed * speedW end
            sum += threat * 0.7
        end
    end

    totalThreatLabel.Text = "关卡总威胁值: " .. math.floor(sum)
    if sum > 6000 then
        totalThreatLabel.TextColor3 = Color3.fromRGB(180, 30, 30)
    elseif sum > 4000 then
        totalThreatLabel.TextColor3 = Color3.fromRGB(220, 60, 60)
    elseif sum > 2500 then
        totalThreatLabel.TextColor3 = Color3.fromRGB(255, 120, 120)
    else
        totalThreatLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    end
end

-- 初始化循环
RunService.RenderStepped:Connect(updateTotalThreat)

task.spawn(function()
    while true do
        for _, folder in ipairs({FriendlyFolder, EnemyFolder}) do
            local isFriendly = folder == FriendlyFolder
            for _, npc in ipairs(folder:GetChildren()) do
                if npc:FindFirstChild("Humanoid") then
                    createBillboard(npc, isFriendly)
                end
            end
        end
        task.wait(1)
    end
end)
